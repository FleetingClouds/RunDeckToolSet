- id: net.fleetingclouds.install.chef.bootstrap
  project: PrepareGenericVPS
  loglevel: INFO
  sequence:
    keepgoing: true
    strategy: node-first
    commands:
    - exec: echo "Preparing Chef client ............................................."
    - exec: sudo pwd
    - exec: echo "Register OpsCode as apt repo. . . . . . . . . . . . . "
    - script: |+
        VER=`lsb_release -cs`
        echo ${VER}
        DEB="deb http://apt.opscode.com/ ${VER}-0.10 main"
        echo ${DEB} | tee  ./opscode.list

    - exec: sudo mv opscode.list /etc/apt/sources.list.d/
    - exec: echo "Get its GPG key . . . . . . . . . . . . . . . . . . . "
    - exec: gpg --fetch-key http://apt.opscode.com/packages@opscode.com.gpg.key > /dev/null
    - exec: echo "Make a directory for the key ring . . . . . . . . . . . . . . . . . . "
    - exec: sudo mkdir -p /etc/apt/trusted.gpg.d/
    - exec: echo "Get packages key ring. . . . . . . . . . . . . . . . . . . . . "
    - exec: gpg --export packages@opscode.com | tee ./opscode-keyring.gpg > /dev/null
    - exec: sudo mv ./opscode-keyring.gpg /etc/apt/trusted.gpg.d/
    - exec: echo "Update aptitude . . . . . . . . . . . . . . . . . . "
    - exec: sudo aptitude update
    - exec: echo "Prepare a permanent upgradeable keyring. . . . . . . "
    - exec: sudo aptitude install opscode-keyring
    - exec: echo "Upgrade to latest . . . . . "
    - exec: sudo aptitude upgrade
    - exec: echo "Done preparing Chef hostname ................................................."
    - exec: echo ". . . . . . . . . . . . . . . . . . . . . . . . . . . . "
    - exec: VER=`lsb_release -cs`  && echo ${VER}
  description: From a properly configured Chef workstation this sends across the bootstrap scripts to the client,.
  name: BootstrapClient
  uuid: net.fleetingclouds.install.chef.bootstrap
  nodefilters:
    dispatch:
      threadcount: 1
      keepgoing: false
      excludePrecedence: true
      rankOrder: ascending
    include:
      name: gate.*
  group: net/fleetingclouds/install/chef
  options:
    sudoPwdRunDeck:
      required: true
      description: Chef's password.
      value: okmmpl,,
      secure: true
