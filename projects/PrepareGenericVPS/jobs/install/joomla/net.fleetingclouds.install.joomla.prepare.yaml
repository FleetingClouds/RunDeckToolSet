- id: net.fleetingclouds.install.joomla.prepare
  project: PrepareGenericVPS
  loglevel: INFO
  sequence:
    keepgoing: false
    strategy: node-first
    commands:
    - exec: echo " Start - - - "
    - exec: 'echo " ####################  Calling [JoomlaConf] ###################
        "'
    - jobref:
        group: net/fleetingclouds/install/joomla
        name: JoomlaConf
        args: -MySqlJoomlaPwd ${option.MySqlJoomlaPwd} -JoomlaTblPrefix ${option.JoomlaTblPrefix}
    - script: |-
        #!/bin/bash
        #
        mkdir -p  @option.InstallersRepository@
        pushd  @option.InstallersRepository@
        echo "Stepping into ..."
        pwd
        #
        echo "Getting zipp'd source ..."
        wget -nc -c http://joomlacode.org/gf/download/frsrelease/17138/74603/Joomla_@option.InstallerVersion@_Package.tar.bz2 2> /dev/null 

                    
        popd
        #
        mkdir -p  @option.BuildDirectory@/
        #
        #
        rm -f tmp.sh
        #
        cat > tmp.sh <<EOF
        #!/bin/bash  
        #
        cd @option.BuildDirectory@
        echo "Stepping into ..."
        pwd
        #
        # 
        echo "Unzip the downloaded file" 
        tar xvfj @option.InstallersRepository@/Joomla_@option.InstallerVersion@_Package.tar.bz2
        #
        echo "Remove Apache's default index.html"
        if [ -e index.html ]; then sudo mv index.html apache_hello.html; fi
        #
        echo ". . . . . . Step into /usr/local/apache/htdocs >>>>>"
        pushd /usr/local/apache/htdocs/
          #
          echo ">>  Remove Joomla's installation directory"
          mkdir -p /usr/local/src/joomla/
          if [ -e installation ]; then
            rm -fr /usr/local/src/joomla/installation
            mv installation /usr/local/src/joomla/
          fi
          #
          echo "Provide Joomla with a configuration file"
          if [ ! -e configuration.php ]; then cp $HOME/configuration.php .; fi
          #
        echo ". . . . . . Step out of /usr/local/apache/htdocs <<<<<"
        popd
        #
        echo "Restart Apache"
        /etc/init.d/apache restart
        #
        #
        EOF
        #
        chmod a+x tmp.sh
    - exec: sudo ./tmp.sh
    - exec: echo " - - - End."
  description: ''
  name: PrepareJoomla
  uuid: net.fleetingclouds.install.joomla.prepare
  nodefilters:
    dispatch:
      threadcount: 1
      keepgoing: false
      excludePrecedence: true
      rankOrder: ascending
    include:
      name: mol.*
  group: net/fleetingclouds/install/joomla
  options:
    BuildDirectory:
      required: true
      description: Where programs are built.
      value: /usr/local/apache/htdocs/
    InstallerVersion:
      required: true
      value: 2.5.5-Stable-Full
    InstallersRepository:
      required: true
      value: ~/installers
    JoomlaTblPrefix:
      required: true
      description: The table identifier that permits muliple sites to use one database.
      value: mol01_
    MySqlJoomlaPwd:
      required: true
    sudoPwdRunDeck:
      required: true
      description: RunDeck's password
      value: okmmpl,,
      secure: true
